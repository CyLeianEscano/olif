<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Campus Lost &amp; Found – Admin Dashboard</title>
    <link rel="stylesheet" href="/css/styles.css" />
  </head>
  <body>
    <div class="app-shell">
      <div class="card">
        <div class="card-inner">
          <header class="app-header">
            <div class="brand">
              <div class="brand-logo">LF</div>
              <div class="brand-text">
                <div class="brand-title">Campus Lost &amp; Found</div>
                <div class="brand-subtitle">Admin dashboard</div>
              </div>
            </div>
            <div class="nav-tabs">
              <button id="logoutBtn" class="nav-link">
                <span>Logout</span>
              </button>
            </div>
          </header>

          <main>
            <h2 class="page-title">Manage found items</h2>
            <p class="page-description">
              Record newly turned-in items and manage unclaimed items.
            </p>

            <div class="layout-two-col">
              <section>
                <div class="form-card">
                  <div class="search-bar">
                    <label class="field-label">Search unclaimed items</label>
                    <input
                      type="text"
                      id="searchInput"
                      class="input"
                      placeholder="Search items (type, color, location, station)..."
                    />
                    <div class="actions-row" style="justify-content:flex-start;margin-top:8px;">
                      <button id="searchBtn" class="button button-primary" type="button">
                        Search
                      </button>
                      <button id="clearSearchBtn" class="button button-outline" type="button">
                        Clear
                      </button>
                    </div>
                  </div>
                </div>

                <div class="summary-card" style="margin-top:16px;">
                  <div class="summary-title">Unclaimed found items</div>
                  <div id="foundItems"></div>
                </div>

                <div class="summary-card" style="margin-top:16px;">
                  <div class="summary-title">Recent lost reports</div>
                  <div id="lostItems"></div>
                </div>
              </section>

              <section>
                <div class="form-card">
                  <h3 class="page-title" style="font-size:16px;margin-bottom:10px;">
                    Add found item
                  </h3>
                  <form id="foundForm" class="form-grid">
                    <div class="form-grid-full">
                      <label class="field-label">
                        Item type <span class="required">*</span>
                      </label>
                      <input
                        type="text"
                        id="itemType"
                        class="input"
                        required
                      />
                    </div>

                    <div>
                      <label class="field-label">
                        Item color <span class="required">*</span>
                      </label>
                      <select class="select" id="itemColor" required>
                        <option value="">Select color</option>
                        <option value="Black">Black</option>
                        <option value="White">White</option>
                        <option value="Blue">Blue</option>
                        <option value="Red">Red</option>
                        <option value="Green">Green</option>
                        <option value="Yellow">Yellow</option>
                        <option value="Gray">Gray</option>
                        <option value="Brown">Brown</option>
                        <option value="Purple">Purple</option>
                        <option value="Pink">Pink</option>
                        <option value="Orange">Orange</option>
                        <option value="Silver">Silver</option>
                        <option value="Gold">Gold</option>
                        <option value="Other">Other</option>
                      </select>
                    </div>

                    <div>
                      <label class="field-label">
                        Location found <span class="required">*</span>
                      </label>
                      <select class="select" id="locationFound" required>
                        <option value="">Select location</option>
                        <option value="College of Engineering and Architecture">College of Engineering and Architecture</option>
                        <option value="College of Teacher Education">College of Teacher Education</option>
                        <option value="College of Arts and Sciences">College of Arts and Sciences</option>
                        <option value="College of Business and Accountancy">College of Business and Accountancy</option>
                        <option value="College of Computing and Information Sciences">College of Computing and Information Sciences</option>
                        <option value="College of Criminal Justice Education">College of Criminal Justice Education</option>
                        <option value="College of Maritime Studies">College of Maritime Studies</option>
                        <option value="College of Industrial Technology">College of Industrial Technology</option>
                        <option value="LHS Laboratory Highschool">LHS Laboratory Highschool</option>
                        <option value="Pool">Pool</option>
                        <option value="Library">Library</option>
                        <option value="Oval">Oval</option>
                        <option value="Meeting Hall">Meeting Hall</option>
                        <option value="Covered Court">Covered Court</option>
                        <option value="Cafeteria near main gate">Cafeteria near main gate</option>
                        <option value="Cafeteria near CTE">Cafeteria near CTE</option>
                        <option value="Other">Other</option>
                      </select>
                    </div>

                    <div class="form-grid-full">
                      <label class="field-label">
                        Found by (name) <span class="required">*</span>
                      </label>
                      <input
                        type="text"
                        id="foundByName"
                        class="input"
                        required
                      />
                    </div>

                    <div class="form-grid-full">
                      <label class="field-label">
                        Station kept <span class="required">*</span>
                      </label>
                      <input
                        type="text"
                        id="stationKept"
                        class="input"
                        required
                      />
                    </div>

                    <div class="form-grid-full">
                      <label class="field-label">Additional notes</label>
                      <textarea
                        id="additionalNotes"
                        class="textarea"
                        placeholder="Condition, special marks, etc."
                      ></textarea>
                    </div>

                    <div class="form-grid-full actions-row">
                      <button type="submit" class="button button-primary">
                        Add found item
                      </button>
                    </div>
                  </form>
                </div>
              </section>
            </div>
          </main>
        </div>
      </div>
    </div>

    <script>
      const currentAdmin = JSON.parse(localStorage.getItem("currentUser"));
      if (!currentAdmin || currentAdmin.role !== "admin") {
        window.location.href = "/";
      }

      document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.removeItem("currentUser");
        window.location.href = "/";
      });

      let allItems = [];
      let allLostReports = [];

      async function loadFoundItems() {
        const res = await fetch("/found-items");
        allItems = await res.json();
        renderItems(allItems);
      }

      async function loadLostItems() {
        const res = await fetch("/admin-lost-items");
        allLostReports = await res.json();
        renderLostItems(allLostReports);
      }

      function renderLostItems(items) {
        const container = document.getElementById("lostItems");
        if (!container) return;
        container.innerHTML = "";
        if (!items.length) {
          container.innerHTML = '<div class="helper-text">No recent lost reports.</div>';
          return;
        }
        items.forEach((item) => {
          const row = document.createElement("div");
          row.className = "summary-item";

          const label = document.createElement("span");
          label.className = "label";
          label.textContent = item.itemType + " (" + item.itemColor + ")";

          const value = document.createElement("span");
          value.className = "value";
          const parts = [];
          if (item.locationLost) parts.push(item.locationLost);
          if (item.User && item.User.fullName) parts.push("by " + item.User.fullName);
          value.textContent = parts.join(" · ");

          row.appendChild(label);
          row.appendChild(value);
          container.appendChild(row);
        });
      }

      function renderItems(items) {
        const container = document.getElementById("foundItems");
        container.innerHTML = "";
        if (!items.length) {
          container.innerHTML = '<div class="helper-text">No items found.</div>';
          return;
        }
        items.forEach(item => {
          const row = document.createElement("div");
          row.className = "summary-item";

          const label = document.createElement("span");
          label.className = "label";
          label.textContent = (item.itemType || "Item") + " (" + (item.itemColor || "") + ")";

          const value = document.createElement("span");
          value.className = "value";
          value.textContent =
            (item.locationFound || "") +
            (item.stationKept ? " · " + item.stationKept : "");

          const button = document.createElement("button");
          button.setAttribute("data-id", item.id);
          button.className = "button button-primary button-claim";
          button.style.padding = "3px 8px";
          button.style.fontSize = "11px";
          button.style.marginLeft = "6px";
          button.textContent = "Mark claimed";

          value.appendChild(button);

          row.appendChild(label);
          row.appendChild(value);
          container.appendChild(row);
        });

        container.querySelectorAll(".button-claim").forEach(btn => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            const res = await fetch(`/found-items/${id}/claim`, { 
              method: "POST",
              headers: { "X-Admin-Id": currentAdmin.id }
            });
            if (res.ok) {
              alert("Item marked as claimed");
              loadFoundItems();
            } else {
              const err = await res.json();
              alert("Error: " + err.error);
            }
          });
        });
      }

      function filterItems(term) {
        term = term.toLowerCase();
        return allItems.filter(item => {
          return (
            (item.itemType || "").toLowerCase().includes(term) ||
            (item.itemColor || "").toLowerCase().includes(term) ||
            (item.locationFound || "").toLowerCase().includes(term) ||
            (item.stationKept || "").toLowerCase().includes(term)
          );
        });
      }

      document.getElementById("searchBtn").addEventListener("click", () => {
        const term = document.getElementById("searchInput").value.trim();
        if (!term) {
          renderItems(allItems);
          return;
        }
        renderItems(filterItems(term));
      });

      document.getElementById("clearSearchBtn").addEventListener("click", () => {
        document.getElementById("searchInput").value = "";
        renderItems(allItems);
      });

      loadFoundItems();
      loadLostItems();

      document.getElementById("foundForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const body = {
          itemType: document.getElementById("itemType").value,
          itemColor: document.getElementById("itemColor").value,
          locationFound: document.getElementById("locationFound").value,
          foundByName: document.getElementById("foundByName").value,
          stationKept: document.getElementById("stationKept").value,
          additionalNotes: document.getElementById("additionalNotes").value,
          createdByAdminId: currentAdmin.id
        };
        const res = await fetch("/found-items", {
          method: "POST",
          headers: { "Content-Type": "application/json", "X-Admin-Id": currentAdmin.id },
          body: JSON.stringify(body)
        });

        if (res.ok) {
          alert("Found item added");
          e.target.reset();
          loadFoundItems();
          loadLostItems();
        } else {
          const err = await res.json();
          alert("Error: " + err.error);
        }
      });
    </script>
  </body>
</html>